<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Islami</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, "Helvetica Neue", Arial;
      color: #fff;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      background-size: cover;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: rgba(0,0,0,0.75);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      width: 90%;
      max-width: 520px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.7);
      animation: fadeIn 400ms ease-in-out;
    }
    h1 { font-size: 26px; margin-bottom: 14px; color: #fff; }
    h2 { font-size: 20px; margin: 16px 0 8px; color: #fff; }
    button {
      display:flex; align-items:center; justify-content:center;
      gap:8px; width:100%; padding:12px; margin:8px 0;
      border-radius:10px; border:none; font-size:18px; font-weight:700;
      background:#ffcc00; color:#000; cursor:pointer;
      transition: transform .15s ease, background .15s ease;
    }
    button:hover { transform: scale(1.03); background:#ffb300; }
    button:active { transform: scale(0.98); }
    .hidden { display:none; }
    .prayer-time {
      display:flex; justify-content:space-between;
      padding:10px; background: rgba(255,255,255,0.08);
      border-radius:8px; margin:6px 0;
    }
    input[type="text"], input[list] {
      width:100%; padding:10px; border-radius:8px; border: none; margin: 8px 0;
      font-size:16px;
    }
    small { display:block; margin-top:6px; opacity:.95; color:#fff; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(10px)} to {opacity:1; transform:none} }
    
    /* Styling untuk fitur sholawat dan quran */
    .audio-item {
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      text-align: left;
      cursor: pointer;
      transition: background .2s ease;
    }
    .audio-item:hover {
      background: rgba(255,255,255,0.15);
    }
    .audio-title {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .audio-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .play-btn {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .stop-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    .progress-container {
      flex-grow: 1;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #ffcc00;
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-display {
      font-size: 14px;
      min-width: 100px;
      text-align: right;
    }
    
    /* Styling untuk fitur Al-Quran */
    .surah-item {
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      text-align: left;
      cursor: pointer;
      transition: background .2s ease;
    }
    .surah-item:hover {
      background: rgba(255,255,255,0.15);
    }
    .surah-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .surah-details {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* Status indicator */
    .status {
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      margin: 5px 0;
      display: inline-block;
    }
    .status.playing {
      background: rgba(40, 167, 69, 0.3);
      color: #28a745;
    }
    .status.stopped {
      background: rgba(220, 53, 69, 0.3);
      color: #dc3545;
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Auto-play toggle */
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }
    .toggle-label {
      font-size: 14px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: #28a745;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Halaman Awal -->
    <div id="halaman-awal">
      <h1>üì± Aplikasi Islami</h1>
      <button onclick="showMenu()">üöÄ Mulai</button>
    </div>

    <!-- Menu Utama -->
    <div id="menu-utama" class="hidden">
      <h1>üåô Menu Utama</h1>
      <button onclick="showPage('jadwal')"><span>üïå</span>&nbsp;Jadwal Azan</button>
      <button onclick="showPage('sholawat')"><span>üïå</span>&nbsp;Audio Sholawat</button>
      <button onclick="showPage('quran')"><span>üìñ</span>&nbsp;Audio Al-Quran</button>
      <button onclick="backToHome()">‚¨Ö Kembali</button>
    </div>

    <!-- Halaman Jadwal Azan -->
    <div id="halaman-jadwal" class="hidden">
      <h1>üïå Jadwal Azan</h1>

      <!-- Autocomplete: datalist akan diisi dari API -->
      <input list="daftarKota" id="city" placeholder="Ketik lalu pilih dari daftar (contoh: Bandung)" autocomplete="off" />
      <datalist id="daftarKota"></datalist>

      <button onclick="cariKota()">üîç Cari</button>
      <div id="jadwal"></div>
      <small id="infoJadwal"></small>
      <button onclick="backToMenu()">‚¨Ö Menu Utama</button>
    </div>

    <!-- Halaman Sholawat -->
    <div id="halaman-sholawat" class="hidden">
      <h1>üïå Audio Sholawat</h1>
      <div id="status-sholawat" class="status stopped">Tidak ada audio yang diputar</div>
      
      <!-- Toggle Auto-play -->
      <div class="toggle-container">
        <span class="toggle-label">Auto-play sholawat berikutnya</span>
        <label class="toggle-switch">
          <input type="checkbox" id="autoPlaySholawatToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div id="daftar-sholawat"></div>
      <button onclick="backToMenu()">‚¨Ö Menu Utama</button>
    </div>

    <!-- Halaman Al-Quran -->
    <div id="halaman-quran" class="hidden">
      <h1>üìñ Audio Al-Quran</h1>
      <div id="status-quran" class="status stopped">Tidak ada audio yang diputar</div>
      
      <!-- Toggle Auto-play -->
      <div class="toggle-container">
        <span class="toggle-label">Auto-play surah berikutnya</span>
        <label class="toggle-switch">
          <input type="checkbox" id="autoPlayQuranToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div id="daftar-surah"></div>
      <button onclick="backToMenu()">‚¨Ö Menu Utama</button>
    </div>
  </div>

  <!-- Audio Elements -->
  <audio id="audioSubuh" src="subuh.mp3"></audio>
  <audio id="audioLain" src="upin.mp3"></audio>
  
  <!-- Audio untuk sholawat dan Quran akan dibuat secara dinamis -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ====== Firebase config ======
    const firebaseConfig = {
      apiKey: "AIzaSyCZllUASe1Cg0n_yzq1vbCO-NzXhh2Y4_M",
      authDomain: "randy-f5402.firebaseapp.com",
      databaseURL: "https://randy-f5402-default-rtdb.firebaseio.com",
      projectId: "randy-f5402",
      storageBucket: "randy-f5402.firebasestorage.app",
      messagingSenderId: "278462073349",
      appId: "1:278462073349:web:8dc5da4642197b858faa6c",
      measurementId: "G-0KVGSYR8XR"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ====== GLOBAL VARIABLES ======
    let ALL_KOTA = [];
    let LAST_RENDERED_JADWAL = null;
    let AZAN_INTERVAL = null;
    let CURRENT_PLAYING_AUDIO = null;
    let AUDIO_PROGRESS_INTERVAL = null;
    let ALL_SURAH_DATA = [];
    let ALL_SHOLAWAT_DATA = [];
    let CURRENT_SURAH_INDEX = -1;
    let CURRENT_SHOLAWAT_INDEX = -1;

    // ====== NAVIGATION ======
    window.showMenu = function () {
      document.getElementById("halaman-awal").classList.add("hidden");
      document.getElementById("menu-utama").classList.remove("hidden");
    };
    window.backToHome = function () {
      hideAll();
      document.getElementById("halaman-awal").classList.remove("hidden");
    };
    window.showPage = function (page) {
      hideAll();
      if (page === "jadwal") {
        document.getElementById("halaman-jadwal").classList.remove("hidden");
        loadAllKota();
        const local = localStorage.getItem("lastCity");
        if (local) {
          try {
            const obj = JSON.parse(local);
            if (obj && obj.name) {
              document.getElementById("city").value = obj.name;
              cariKota(obj.name);
              return;
            }
          } catch(e) { /* ignore */ }
        }
        get(child(ref(db), 'users/lastCity')).then(snap => {
          if (snap.exists()) {
            const v = snap.val();
            if (v && v.name) {
              document.getElementById("city").value = v.name;
              cariKota(v.name);
            }
          }
        }).catch(err => { console.warn("Firebase read lastCity err:", err); });
      }
      if (page === "sholawat") {
        document.getElementById("halaman-sholawat").classList.remove("hidden");
        loadSholawat();
      }
      if (page === "quran") {
        document.getElementById("halaman-quran").classList.remove("hidden");
        loadSurahList();
      }
    };
    window.backToMenu = function () {
      hideAll();
      document.getElementById("menu-utama").classList.remove("hidden");
    };
    function hideAll() {
      document.querySelectorAll(".container > div").forEach(div => div.classList.add("hidden"));
    }

    // ====== LOAD ALL KOTA -> datalist autocomplete ======
    async function loadAllKota() {
      if (ALL_KOTA && ALL_KOTA.length > 0) return fillDatalist(ALL_KOTA);
      try {
        const res = await fetch("https://api.myquran.com/v2/sholat/kota/semua");
        const data = await res.json();
        if (data && data.data) {
          ALL_KOTA = data.data;
          fillDatalist(ALL_KOTA);
        } else {
          console.warn("Tidak ada data kota dari API");
        }
      } catch (err) {
        console.error("Gagal muat daftar kota:", err);
      }
    }
    function fillDatalist(list) {
      const datalist = document.getElementById("daftarKota");
      datalist.innerHTML = "";
      list.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k.lokasi;
        opt.dataset.id = k.id;
        datalist.appendChild(opt);
      });
    }

    // ====== SIMPAN KOTA (localStorage + Firebase) ======
    async function simpanKotaTerakhir(id, name) {
      try {
        localStorage.setItem("lastCity", JSON.stringify({ id, name, time: new Date().toISOString() }));
        await set(ref(db, 'users/lastCity'), { id, name, time: new Date().toISOString() });
        console.log("Kota terakhir disimpan:", name);
      } catch (err) {
        console.warn("Gagal simpan kota:", err);
      }
    }

    // ====== CARI KOTA & AMBIL JADWAL ======
    window.cariKota = async function (cityInput) {
      const input = (cityInput || document.getElementById("city").value || "").trim();
      if (!input) { alert("Masukkan nama kota atau kabupaten!"); return; }

      let found = ALL_KOTA.find(k => k.lokasi.toLowerCase() === input.toLowerCase());

      if (!found) {
        try {
          const resCity = await fetch(`https://api.myquran.com/v2/sholat/kota/cari/${encodeURIComponent(input)}`);
          const dataCity = await resCity.json();
          if (dataCity && dataCity.data && dataCity.data.length > 0) {
            found = dataCity.data[0];
            if (!ALL_KOTA.some(k => k.id === found.id)) ALL_KOTA.push(found);
            fillDatalist(ALL_KOTA);
          }
        } catch (err) {
          console.error("error cari kota via API:", err);
        }
      }

      if (!found) {
        alert("Kota/Kabupaten tidak ditemukan. Pilih dari daftar atau cek ejaan.");
        return;
      }

      const cityId = found.id;
      const cityName = found.lokasi;

      simpanKotaTerakhir(cityId, cityName);

      try {
        const now = new Date();
        const y = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");

        const resJ = await fetch(`https://api.myquran.com/v2/sholat/jadwal/${cityId}/${y}/${mm}/${dd}`);
        const dataJ = await resJ.json();
        if (!dataJ || !dataJ.data || !dataJ.data.jadwal) {
          alert("Jadwal azan tidak tersedia untuk kota ini.");
          return;
        }
        const jadwal = dataJ.data.jadwal;
        renderJadwal(cityName, jadwal);
        startCekAzan(jadwal);
      } catch (err) {
        console.error("Gagal ambil jadwal:", err);
        alert("Gagal mengambil jadwal azan.");
      }
    };

    function renderJadwal(cityName, jadwal) {
      LAST_RENDERED_JADWAL = jadwal;
      document.getElementById("jadwal").innerHTML = `
        <h3>üìç ${cityName}</h3>
        <div class="prayer-time"><span>Subuh</span><span>${jadwal.subuh}</span></div>
        <div class="prayer-time"><span>Dzuhur</span><span>${jadwal.dzuhur}</span></div>
        <div class="prayer-time"><span>Ashar</span><span>${jadwal.ashar}</span></div>
        <div class="prayer-time"><span>Maghrib</span><span>${jadwal.maghrib}</span></div>
        <div class="prayer-time"><span>Isya</span><span>${jadwal.isya}</span></div>
      `;
      document.getElementById("infoJadwal").innerText = "Jadwal diambil dari myquran.com";
    }

    // ====== AZAN OTOMATIS ======
    function startCekAzan(jadwal) {
      if (!jadwal) return;
      if (AZAN_INTERVAL) clearInterval(AZAN_INTERVAL);

      const audioSubuh = document.getElementById("audioSubuh");
      const audioLain = document.getElementById("audioLain");

      const safePlay = async (audioEl) => {
        // Hentikan semua audio sholawat dan Quran sebelum azan
        stopAllAudio();
        
        try { 
          await audioEl.play(); 
          console.log("Azan dimainkan");
        }
        catch (e) { 
          console.warn("Audio play blocked by browser:", e); 
        }
      };

      AZAN_INTERVAL = setInterval(() => {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        const curHM = `${hh}:${mm}`;

        if (!startCekAzan.lastPlayed) startCekAzan.lastPlayed = null;
        if (curHM === jadwal.subuh) {
          if (startCekAzan.lastPlayed !== curHM) { 
            safePlay(audioSubuh); 
            startCekAzan.lastPlayed = curHM; 
          }
        } else if ([jadwal.dzuhur, jadwal.ashar, jadwal.maghrib, jadwal.isya].includes(curHM)) {
          if (startCekAzan.lastPlayed !== curHM) { 
            safePlay(audioLain); 
            startCekAzan.lastPlayed = curHM; 
          }
        } else {
          startCekAzan.lastPlayed = null;
        }
      }, 1000);
    }

    // ====== FITUR SHOLAWAT DENGAN AUTO-PLAY ======
    async function loadSholawat() {
      const container = document.getElementById("daftar-sholawat");
      container.innerHTML = "‚è≥ Memuat sholawat...";
      
      // Data sholawat dengan URL audio
      const sholawatList = [
        {
          id: 1,
          title: "Sholawat Jibril",
          audioUrl: "Audio/sholawat jibril.mp3",
        },
        {
          id: 2,
          title: "Sholawat Ibrahimiyah", 
          audioUrl: "Audio/sholawat ibrahim.mp3",
        },
        {
          id: 3,
          title: "Sholawat Nariyah",
          audioUrl: "Audio/sholawat nariyah.mp3",
        },
        {
          id: 4,
          title: "Sholawat Fatih",
          audioUrl: "Audio/sholawat fatih.mp3",
        },
        {
          id: 5,
          title: "Sholawat Munjiyat",
          audioUrl: "Audio/sholawat munjiyat.mp3",
        },
        {
          id: 6,
          title: "Sholawat Thibbil Qulub",
          audioUrl: "Audio/sholawat qulub.mp3",
        },
        {
          id: 7,
          title: "Sholawat Badar",
          audioUrl: "Audio/sholawat badar.mp3",
        }
      ];

      ALL_SHOLAWAT_DATA = sholawatList; // Simpan data sholawat untuk auto-play

      // Render sholawat list
      container.innerHTML = "";
      sholawatList.forEach(sholawat => {
        const audioId = `audio-sholawat-${sholawat.id}`;
        
        // Buat elemen audio
        const audioElement = document.createElement("audio");
        audioElement.id = audioId;
        audioElement.src = sholawat.audioUrl;
        audioElement.preload = "metadata";
        
        // Tambahkan event listener untuk auto-play
        audioElement.addEventListener('ended', function() {
          handleSholawatEnded(sholawat.id);
        });
        
        document.body.appendChild(audioElement);
        
        const item = document.createElement("div");
        item.className = "audio-item";
        item.innerHTML = `
          <div class="audio-title">
            <span>${sholawat.title}</span>
          </div>
          <div class="audio-controls">
            <button class="play-btn" onclick="playSholawat(${sholawat.id}, '${sholawat.title}')">‚ñ∂</button>
            <button class="stop-btn" onclick="stopAudio('${audioId}', 'sholawat')">‚èπ</button>
            <div class="progress-container">
              <div class="progress-bar" id="progress-${audioId}"></div>
            </div>
            <div class="time-display" id="time-${audioId}">0:00 / ${sholawat.duration}</div>
          </div>
        `;
        container.appendChild(item);
      });
    }

    // ====== FUNGSI AUTO-PLAY SHOLAWAT ======
    function handleSholawatEnded(currentSholawatId) {
      const autoPlayEnabled = document.getElementById('autoPlaySholawatToggle').checked;
      
      if (!autoPlayEnabled) {
        // Reset status jika auto-play dimatikan
        const statusElement = document.getElementById('status-sholawat');
        if (statusElement) {
          statusElement.textContent = "Tidak ada audio yang diputar";
          statusElement.className = "status stopped";
        }
        return;
      }
      
      // Cari index sholawat yang sedang diputar
      const currentIndex = ALL_SHOLAWAT_DATA.findIndex(sholawat => sholawat.id === currentSholawatId);
      
      if (currentIndex !== -1 && currentIndex < ALL_SHOLAWAT_DATA.length - 1) {
        // Auto-play sholawat berikutnya
        const nextSholawat = ALL_SHOLAWAT_DATA[currentIndex + 1];
        
        // Tunggu sebentar sebelum memulai sholawat berikutnya
        setTimeout(() => {
          playSholawat(nextSholawat.id, nextSholawat.title);
        }, 1500); // Delay 1.5 detik sebelum sholawat berikutnya
      } else {
        // Jika ini sholawat terakhir, reset status
        const statusElement = document.getElementById('status-sholawat');
        if (statusElement) {
          statusElement.textContent = "Tidak ada audio yang diputar";
          statusElement.className = "status stopped";
        }
      }
    }

    // ====== FUNGSI PLAY SHOLAWAT ======
    window.playSholawat = function(sholawatId, title) {
      const audioId = `audio-sholawat-${sholawatId}`;
      playAudio(audioId, 'sholawat', title);
      
      // Simpan index sholawat yang sedang diputar
      CURRENT_SHOLAWAT_INDEX = ALL_SHOLAWAT_DATA.findIndex(sholawat => sholawat.id === sholawatId);
    };

    // ====== FITUR AL-QURAN (PER SURAH) DENGAN AUTO-PLAY ======
    async function loadSurahList() {
      const container = document.getElementById("daftar-surah");
      container.innerHTML = "<div class='loading'></div> Memuat daftar surah...";
      
      try {
        const response = await fetch("https://api.alquran.cloud/v1/surah");
        const data = await response.json();
        
        if (data && data.data) {
          ALL_SURAH_DATA = data.data; // Simpan data surah untuk auto-play
          container.innerHTML = "";
          
          // Data URL audio untuk setiap surah - SESUAIKAN DENGAN NAMA FILE ANDA
          const surahAudioData = {
            1: { url: "Audio/alfatihah.mp3", duration: "4:30" },
            2: { url: "Audio/albaqarah.mp3", duration: "2:15:20" },
            3: { url: "Audio/aliimraan.mp3", duration: "1:45:10" },
            4: { url: "Audio/annisa.mp3", duration: "1:35:45" },
            5: { url: "Audio/almaidah.mp3", duration: "1:30:15" },
            6: { url: "Audio/alanam.mp3", duration: "1:40:30" },
            7: { url: "Audio/alaraf.mp3", duration: "1:25:50" },
            8: { url: "Audio/alanfal.mp3", duration: "25:45" },
            9: { url: "Audio/attaubah.mp3", duration: "1:50:20" },
            10: { url: "Audio/yunus.mp3", duration: "1:15:30" },
            11: { url: "Audio/11.mp3", duration: "1:10:45" },
            12: { url: "Audio/12.mp3", duration: "1:20:15" },
            13: { url: "Audio/13.mp3", duration: "45:30" },
            14: { url: "Audio/14.mp3", duration: "52:20" },
            15: { url: "Audio/15.mp3", duration: "40:15" },
            16: { url: "Audio/16.mp3", duration: "1:05:40" },
            17: { url: "Audio/17.mp3", duration: "1:00:25" },
            18: { url: "Audio/18.mp3", duration: "1:15:50" },
            19: { url: "Audio/19.mp3", duration: "55:30" },
            20: { url: "Audio/20.mp3", duration: "1:05:15" },
            21: { url: "Audio/21.mp3", duration: "1:00:40" },
            22: { url: "Audio/22.mp3", duration: "1:10:20" },
            23: { url: "Audio/23.mp3", duration: "1:05:10" },
            24: { url: "Audio/24.mp3", duration: "1:00:45" },
            25: { url: "Audio/25.mp3", duration: "55:30" },
            26: { url: "Audio/26.mp3", duration: "1:20:15" },
            27: { url: "Audio/27.mp3", duration: "1:05:40" },
            28: { url: "Audio/28.mp3", duration: "1:15:25" },
            29: { url: "Audio/29.mp3", duration: "45:30" },
            30: { url: "Audio/30.mp3", duration: "50:20" },
            31: { url: "Audio/31.mp3", duration: "35:15" },
            32: { url: "Audio/32.mp3", duration: "30:45" },
            33: { url: "Audio/33.mp3", duration: "1:25:30" },
            34: { url: "Audio/34.mp3", duration: "55:20" },
            35: { url: "Audio/35.mp3", duration: "45:15" },
            36: { url: "Audio/36.mp3", duration: "40:30" },
            37: { url: "Audio/37.mp3", duration: "1:00:45" },
            38: { url: "Audio/38.mp3", duration: "50:20" },
            39: { url: "Audio/39.mp3", duration: "1:10:15" },
            40: { url: "Audio/40.mp3", duration: "1:15:30" },
            41: { url: "Audio/41.mp3", duration: "55:45" },
            42: { url: "Audio/42.mp3", duration: "50:20" },
            43: { url: "Audio/43.mp3", duration: "1:05:15" },
            44: { url: "Audio/44.mp3", duration: "35:30" },
            45: { url: "Audio/45.mp3", duration: "40:20" },
            46: { url: "Audio/46.mp3", duration: "45:15" },
            47: { url: "Audio/47.mp3", duration: "40:30" },
            48: { url: "Audio/48.mp3", duration: "30:45" },
            49: { url: "Audio/49.mp3", duration: "25:20" },
            50: { url: "Audio/50.mp3", duration: "35:15" },
            51: { url: "Audio/51.mp3", duration: "45:30" },
            52: { url: "Audio/52.mp3", duration: "30:20" },
            53: { url: "Audio/53.mp3", duration: "40:15" },
            54: { url: "Audio/54.mp3", duration: "45:30" },
            55: { url: "Audio/55.mp3", duration: "35:20" },
            56: { url: "Audio/56.mp3", duration: "40:15" },
            57: { url: "Audio/57.mp3", duration: "50:30" },
            58: { url: "Audio/58.mp3", duration: "35:20" },
            59: { url: "Audio/59.mp3", duration: "40:15" },
            60: { url: "Audio/60.mp3", duration: "30:45" },
            61: { url: "Audio/61.mp3", duration: "25:20" },
            62: { url: "Audio/62.mp3", duration: "20:15" },
            63: { url: "Audio/63.mp3", duration: "25:30" },
            64: { url: "Audio/64.mp3", duration: "30:20" },
            65: { url: "Audio/65.mp3", duration: "35:15" },
            66: { url: "Audio/66.mp3", duration: "25:30" },
            67: { url: "Audio/67.mp3", duration: "30:20" },
            68: { url: "Audio/68.mp3", duration: "45:15" },
            69: { url: "Audio/69.mp3", duration: "35:30" },
            70: { url: "Audio/70.mp3", duration: "40:20" },
            71: { url: "Audio/71.mp3", duration: "30:15" },
            72: { url: "Audio/72.mp3", duration: "25:30" },
            73: { url: "Audio/73.mp3", duration: "35:20" },
            74: { url: "Audio/74.mp3", duration: "40:15" },
            75: { url: "Audio/75.mp3", duration: "30:30" },
            76: { url: "Audio/76.mp3", duration: "35:20" },
            77: { url: "Audio/77.mp3", duration: "40:15" },
            78: { url: "Audio/78.mp3", duration: "45:30" },
            79: { url: "Audio/79.mp3", duration: "35:20" },
            80: { url: "Audio/80.mp3", duration: "30:15" },
            81: { url: "Audio/81.mp3", duration: "25:30" },
            82: { url: "Audio/82.mp3", duration: "20:20" },
            83: { url: "Audio/83.mp3", duration: "35:15" },
            84: { url: "Audio/84.mp3", duration: "25:30" },
            85: { url: "Audio/85.mp3", duration: "30:20" },
            86: { url: "Audio/86.mp3", duration: "25:15" },
            87: { url: "Audio/87.mp3", duration: "20:30" },
            88: { url: "Audio/88.mp3", duration: "25:20" },
            89: { url: "Audio/89.mp3", duration: "30:15" },
            90: { url: "Audio/90.mp3", duration: "20:30" },
            91: { url: "Audio/91.mp3", duration: "15:20" },
            92: { url: "Audio/92.mp3", duration: "20:15" },
            93: { url: "Audio/93.mp3", duration: "15:30" },
            94: { url: "Audio/94.mp3", duration: "10:20" },
            95: { url: "Audio/95.mp3", duration: "15:15" },
            96: { url: "Audio/96.mp3", duration: "20:30" },
            97: { url: "Audio/97.mp3", duration: "10:20" },
            98: { url: "Audio/98.mp3", duration: "15:15" },
            99: { url: "Audio/99.mp3", duration: "10:30" },
            100: { url: "Audio/100.mp3", duration: "15:20" },
            101: { url: "Audio/101.mp3", duration: "10:15" },
            102: { url: "Audio/102.mp3", duration: "10:30" },
            103: { url: "Audio/103.mp3", duration: "5:20" },
            104: { url: "Audio/104.mp3", duration: "10:15" },
            105: { url: "Audio/105.mp3", duration: "10:30" },
            106: { url: "Audio/106.mp3", duration: "10:20" },
            107: { url: "Audio/107.mp3", duration: "10:15" },
            108: { url: "Audio/108.mp3", duration: "5:30" },
            109: { url: "Audio/109.mp3", duration: "10:20" },
            110: { url: "Audio/110.mp3", duration: "10:15" },
            111: { url: "Audio/111.mp3", duration: "10:30" },
            112: { url: "Audio/112.mp3", duration: "10:20" },
            113: { url: "Audio/113.mp3", duration: "10:15" },
            114: { url: "Audio/114.mp3", duration: "10:30" }
          };
          
          ALL_SURAH_DATA.forEach(surah => {
            const audioInfo = surahAudioData[surah.number] || { 
              url: `Audio/${surah.number}.mp3`,
              duration: "5:00" 
            };
            
            const audioId = `audio-quran-${surah.number}`;
            
            // Buat elemen audio
            const audioElement = document.createElement("audio");
            audioElement.id = audioId;
            audioElement.src = audioInfo.url;
            audioElement.preload = "metadata";
            
            // Tambahkan event listener untuk auto-play
            audioElement.addEventListener('ended', function() {
              handleSurahEnded(surah.number);
            });
            
            document.body.appendChild(audioElement);
            
            // Fungsi untuk escape karakter khusus dalam string
            const escapeString = (str) => {
              return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
            };
            
            const item = document.createElement("div");
            item.className = "audio-item";
            item.innerHTML = `
              <div class="surah-name">${surah.number}. ${surah.englishName} (${surah.name})</div>
              <div class="surah-details">
                <span>${surah.englishNameTranslation}</span>
                <span>${surah.numberOfAyahs} ayat ‚Ä¢ ${audioInfo.duration}</span>
              </div>
              <div class="audio-controls">
                <button class="play-btn" onclick="playSurah(${surah.number}, '${escapeString(surah.englishName)} (${escapeString(surah.name)})')">‚ñ∂</button>
                <button class="stop-btn" onclick="stopAudio('${audioId}', 'quran')">‚èπ</button>
                <div class="progress-container">
                  <div class="progress-bar" id="progress-${audioId}"></div>
                </div>
                <div class="time-display" id="time-${audioId}">0:00 / ${audioInfo.duration}</div>
              </div>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML = "Gagal memuat daftar surah.";
        }
      } catch (error) {
        console.error("Error loading surah list:", error);
        container.innerHTML = "Gagal memuat daftar surah. Periksa koneksi internet Anda.";
      }
    }

    // ====== FUNGSI AUTO-PLAY SURAH ======
    function handleSurahEnded(currentSurahNumber) {
      const autoPlayEnabled = document.getElementById('autoPlayQuranToggle').checked;
      
      if (!autoPlayEnabled) {
        // Reset status jika auto-play dimatikan
        const statusElement = document.getElementById('status-quran');
        if (statusElement) {
          statusElement.textContent = "Tidak ada audio yang diputar";
          statusElement.className = "status stopped";
        }
        return;
      }
      
      // Cari index surah yang sedang diputar
      const currentIndex = ALL_SURAH_DATA.findIndex(surah => surah.number === currentSurahNumber);
      
      if (currentIndex !== -1 && currentIndex < ALL_SURAH_DATA.length - 1) {
        // Auto-play surah berikutnya
        const nextSurah = ALL_SURAH_DATA[currentIndex + 1];
        
        // Tunggu sebentar sebelum memulai surah berikutnya
        setTimeout(() => {
          playSurah(nextSurah.number, `${nextSurah.englishName} (${nextSurah.name})`);
        }, 1000); // Delay 1 detik sebelum surah berikutnya
      } else {
        // Jika ini surah terakhir, reset status
        const statusElement = document.getElementById('status-quran');
        if (statusElement) {
          statusElement.textContent = "Tidak ada audio yang diputar";
          statusElement.className = "status stopped";
        }
      }
    }

    // ====== FUNGSI PLAY SURAH ======
    window.playSurah = function(surahNumber, title) {
      const audioId = `audio-quran-${surahNumber}`;
      playAudio(audioId, 'quran', title);
      
      // Simpan index surah yang sedang diputar
      CURRENT_SURAH_INDEX = ALL_SURAH_DATA.findIndex(surah => surah.number === surahNumber);
    };

    // ====== AUDIO CONTROL FUNCTIONS ======
    window.playAudio = function(audioId, type, title = '') {
      // Hentikan audio yang sedang diputar sebelumnya
      if (CURRENT_PLAYING_AUDIO && CURRENT_PLAYING_AUDIO.id !== audioId) {
        CURRENT_PLAYING_AUDIO.pause();
        CURRENT_PLAYING_AUDIO.currentTime = 0;
        updateProgressBar(CURRENT_PLAYING_AUDIO.id, 0);
        
        // Reset time display untuk audio sebelumnya
        const prevTimeDisplay = document.getElementById(`time-${CURRENT_PLAYING_AUDIO.id}`);
        if (prevTimeDisplay) {
          const duration = formatTime(CURRENT_PLAYING_AUDIO.duration);
          prevTimeDisplay.textContent = `0:00 / ${duration}`;
        }
      }
      
      const audio = document.getElementById(audioId);
      CURRENT_PLAYING_AUDIO = audio;
      
      // Update status
      const statusElement = document.getElementById(`status-${type}`);
      if (statusElement) {
        statusElement.textContent = `Memutar: ${title}`;
        statusElement.className = `status playing`;
      }
      
      // Mulai pemutaran
      audio.play().catch(e => {
        console.error("Gagal memutar audio:", e);
        if (statusElement) {
          statusElement.textContent = "Gagal memutar audio";
          statusElement.className = `status stopped`;
        }
      });
      
      // Update progress bar
      if (AUDIO_PROGRESS_INTERVAL) clearInterval(AUDIO_PROGRESS_INTERVAL);
      AUDIO_PROGRESS_INTERVAL = setInterval(() => {
        if (audio.paused || audio.ended) {
          clearInterval(AUDIO_PROGRESS_INTERVAL);
          return;
        }
        
        const progress = (audio.currentTime / audio.duration) * 100;
        updateProgressBar(audioId, progress);
        
        // Update waktu
        const currentTime = formatTime(audio.currentTime);
        const duration = formatTime(audio.duration);
        const timeDisplay = document.getElementById(`time-${audioId}`);
        if (timeDisplay) {
          timeDisplay.textContent = `${currentTime} / ${duration}`;
        }
      }, 100);
    };

    window.stopAudio = function(audioId, type) {
      const audio = document.getElementById(audioId);
      audio.pause();
      audio.currentTime = 0;
      
      // Update UI
      updateProgressBar(audioId, 0);
      const timeDisplay = document.getElementById(`time-${audioId}`);
      if (timeDisplay) {
        const duration = formatTime(audio.duration);
        timeDisplay.textContent = `0:00 / ${duration}`;
      }
      
      const statusElement = document.getElementById(`status-${type}`);
      if (statusElement) {
        statusElement.textContent = "Tidak ada audio yang diputar";
        statusElement.className = `status stopped`;
      }
      
      if (AUDIO_PROGRESS_INTERVAL) clearInterval(AUDIO_PROGRESS_INTERVAL);
    };

    function stopAllAudio() {
      // Hentikan semua audio sholawat dan Quran
      document.querySelectorAll('audio').forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
      });
      
      // Reset semua progress bar
      document.querySelectorAll('.progress-bar').forEach(bar => {
        bar.style.width = '0%';
      });
      
      // Reset semua time display
      document.querySelectorAll('.time-display').forEach(display => {
        const audioId = display.id.replace('time-', '');
        const audio = document.getElementById(audioId);
        if (audio) {
          const duration = formatTime(audio.duration);
          display.textContent = `0:00 / ${duration}`;
        }
      });
      
      // Reset status
      const statusSholawat = document.getElementById('status-sholawat');
      const statusQuran = document.getElementById('status-quran');
      if (statusSholawat) {
        statusSholawat.textContent = "Tidak ada audio yang diputar";
        statusSholawat.className = "status stopped";
      }
      if (statusQuran) {
        statusQuran.textContent = "Tidak ada audio yang diputar";
        statusQuran.className = "status stopped";
      }
      
      if (AUDIO_PROGRESS_INTERVAL) clearInterval(AUDIO_PROGRESS_INTERVAL);
    }

    function updateProgressBar(audioId, progress) {
      const progressBar = document.getElementById(`progress-${audioId}`);
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }
    }

    function formatTime(seconds) {
      if (isNaN(seconds)) return "0:00";
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // ====== On initial load ======
    window.addEventListener('load', async () => {
      await loadAllKota();
      const lastLocal = localStorage.getItem('lastCity');
      if (lastLocal) {
        try {
          const obj = JSON.parse(lastLocal);
          if (obj && obj.name) {
            document.getElementById('city').value = obj.name;
            cariKota(obj.name);
          }
        } catch (e) { /* ignore parse error */ }
      } else {
        try {
          const snap = await get(child(ref(db), 'users/lastCity'));
          if (snap.exists()) {
            const val = snap.val();
            if (val && val.name) {
              document.getElementById('city').value = val.name;
              cariKota(val.name);
            }
          }
        } catch (err) {
          console.warn('Gagal baca lastCity dari firebase:', err);
        }
      }
    });

    // Cleanup before unload
    window.addEventListener('beforeunload', () => {
      if (AZAN_INTERVAL) clearInterval(AZAN_INTERVAL);
      if (AUDIO_PROGRESS_INTERVAL) clearInterval(AUDIO_PROGRESS_INTERVAL);
    });

  </script>
</body>
</html>